<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Nande Nihon</title>
    <link rel="icon" type="image/png" href="../asset/img/favicon.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="layout">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Admin Panel</h2>
                <p>Nande Nihon CMS</p>
            </div>
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <button class="nav-button active" data-section="dashboard">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                        </svg>
                        Dashboard
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-button" data-section="team">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0 0 0 18.54 8H17c-.8 0-1.54.37-2.01.99L12 11l-2.99-2.01A2.5 2.5 0 0 0 7 8H5.46c-.8 0-1.54.37-2.01.99L1 14.37 3.5 22H6v-6h2v6h2v-6h2v6h2v-6h2v6h2z"/>
                        </svg>
                        Team
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-button" data-section="testimoni">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                        </svg>
                        Testimoni
                    </button>
                </div>
                <div class="nav-item">
                    <button class="nav-button" data-section="notes">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                        Artikel
                    </button>
                </div>
            </nav>
            <button class="logout-btn" id="logoutBtn">
                <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px; margin-right: 8px;">
                    <path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z"/>
                </svg>
                Logout
            </button>
        </div>

        <!-- Main Content -->
        <div class="content">
            <div class="topbar">
                <h1 id="pageTitle">Dashboard</h1>
                <div class="user-info">
                    <span id="userEmail">admin@nandenihon.com</span>
                </div>
            </div>

            <div class="main-content">
                <!-- Dashboard Overview -->
                <div id="dashboard-section" class="section active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h3>Total Team Members</h3>
                            <div class="number" id="teamCount">0</div>
                            <div class="change">+2 this month</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Testimonials</h3>
                            <div class="number" id="testimoniCount">0</div>
                            <div class="change">+5 this month</div>
                        </div>
                        <div class="stat-card">
                            <h3>Published Articles</h3>
                            <div class="number" id="notesCount">0</div>
                            <div class="change">+3 this month</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="table-header">
                            <h3>Recent Activity</h3>
                            <button class="btn" onclick="loadSection('team')">View All</button>
                        </div>
                        <div id="recentActivity">
                            <div class="loading">Loading recent activity...</div>
                        </div>
                    </div>
                </div>

                <!-- Team Management -->
                <div id="team-section" class="section">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Team Members</h3>
                            <button class="btn" onclick="openModal('team')">Add Member</button>
                        </div>
                        <div id="teamTable">
                            <div class="loading">Loading team members...</div>
                        </div>
                    </div>
                </div>

                <!-- Testimoni Management -->
                <div id="testimoni-section" class="section">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Testimonials</h3>
                            <button class="btn" onclick="openModal('testimoni')">Add Testimonial</button>
                        </div>
                        <div id="testimoniTable">
                            <div class="loading">Loading testimonials...</div>
                        </div>
                    </div>
                </div>

                <!-- Notes/Articles Management -->
                <div id="notes-section" class="section">
                    <div class="table-container">
                        <div class="table-header">
                            <h3>Articles</h3>
                            <button class="btn" onclick="openModal('notes')">Add Article</button>
                        </div>
                        <div id="notesTable">
                            <div class="loading">Loading articles...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Add Item</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Supabase configuration
        const SUPABASE_URL = 'https://bpzeveffsxawqdbojkfu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwemV2ZWZmc3hhd3FkYm9qa2Z1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0ODkxOTMsImV4cCI6MjA3MzA2NTE5M30.LzL2-yLVxC3Gh6-a-nF5kAEi3vhc-ENMGctpBbuLdhA';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentUser = null;
        let currentSection = 'dashboard';

        // DOM elements
        const pageTitle = document.getElementById('pageTitle');
        const userEmail = document.getElementById('userEmail');
        const logoutBtn = document.getElementById('logoutBtn');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');

        // Check authentication and initialize
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            currentUser = session.user;
            userEmail.textContent = currentUser.email;
            
            // Load dashboard data
            await loadDashboard();
            
            // Set up event listeners
            setupEventListeners();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Navigation buttons
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    const section = btn.dataset.section;
                    loadSection(section);
                });
            });

            // Logout button
            logoutBtn.addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'login.html';
            });

            // Modal close
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });
        }

        // Load section
        async function loadSection(section) {
            // Update navigation
            document.querySelectorAll('.nav-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-section="${section}"]`).classList.add('active');

            // Hide all sections
            document.querySelectorAll('.section').forEach(sec => {
                sec.classList.remove('active');
            });

            // Show current section
            document.getElementById(`${section}-section`).classList.add('active');

            // Update page title
            pageTitle.textContent = section.charAt(0).toUpperCase() + section.slice(1);

            // Load section data
            currentSection = section;
            switch (section) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'team':
                    await loadTeam();
                    break;
                case 'testimoni':
                    await loadTestimoni();
                    break;
                case 'notes':
                    await loadNotes();
                    break;
            }
        }

        // Load dashboard overview
        async function loadDashboard() {
            try {
                // Load counts
                const [teamData, testimoniData, notesData] = await Promise.all([
                    supabase.from('team').select('id', { count: 'exact' }),
                    supabase.from('testimoni').select('id', { count: 'exact' }),
                    supabase.from('notes').select('id', { count: 'exact' }).eq('is_published', true)
                ]);

                document.getElementById('teamCount').textContent = teamData.count || 0;
                document.getElementById('testimoniCount').textContent = testimoniData.count || 0;
                document.getElementById('notesCount').textContent = notesData.count || 0;

                // Load recent activity
                await loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Load recent activity
        async function loadRecentActivity() {
            const recentActivity = document.getElementById('recentActivity');
            recentActivity.innerHTML = '<div class="loading">Loading recent activity...</div>';

            try {
                const { data: teamData } = await supabase
                    .from('team')
                    .select('nama, created_at')
                    .order('created_at', { ascending: false })
                    .limit(3);

                const { data: testimoniData } = await supabase
                    .from('testimoni')
                    .select('name, created_at')
                    .order('created_at', { ascending: false })
                    .limit(3);

                const activities = [
                    ...(teamData || []).map(item => ({
                        type: 'team',
                        text: `New team member: ${item.nama}`,
                        date: new Date(item.created_at)
                    })),
                    ...(testimoniData || []).map(item => ({
                        type: 'testimoni',
                        text: `New testimonial from ${item.name}`,
                        date: new Date(item.created_at)
                    }))
                ].sort((a, b) => b.date - a.date).slice(0, 5);

                if (activities.length === 0) {
                    recentActivity.innerHTML = '<div class="empty-state">No recent activity</div>';
                    return;
                }

                recentActivity.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Activity</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${activities.map(activity => `
                                <tr>
                                    <td>${escapeHtml(activity.text)}</td>
                                    <td>${activity.date.toLocaleDateString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                recentActivity.innerHTML = '<div class="error">Error loading recent activity</div>';
            }
        }

        // Load team data
        async function loadTeam() {
            const teamTable = document.getElementById('teamTable');
            teamTable.innerHTML = '<div class="loading">Loading team members...</div>';

            try {
                const { data, error } = await supabase
                    .from('team')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    teamTable.innerHTML = '<div class="empty-state">No team members found</div>';
                    return;
                }

                teamTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Position</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(member => `
                                <tr>
                                    <td>
                                        <img src="${member.photo || 'https://placehold.co/40'}" 
                                             alt="${escapeHtml(member.nama)}" 
                                             style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                    </td>
                                    <td>${escapeHtml(member.nama || '')}</td>
                                    <td>${escapeHtml(member.jabatan || '')}</td>
                                    <td>${escapeHtml(member.email || '')}</td>
                                    <td class="actions">
                                        <button class="btn btn-sm btn-secondary" onclick="editItem('team', ${member.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteItem('team', ${member.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                teamTable.innerHTML = `<div class="error">Error loading team: ${error.message}</div>`;
            }
        }

        // Load testimoni data
        async function loadTestimoni() {
            const testimoniTable = document.getElementById('testimoniTable');
            testimoniTable.innerHTML = '<div class="loading">Loading testimonials...</div>';

            try {
                const { data, error } = await supabase
                    .from('testimoni')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    testimoniTable.innerHTML = '<div class="empty-state">No testimonials found</div>';
                    return;
                }

                testimoniTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Photo</th>
                                <th>Name</th>
                                <th>Age</th>
                                <th>Testimonial</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(testimoni => `
                                <tr>
                                    <td>
                                        <img src="${testimoni.image || 'https://placehold.co/40'}" 
                                             alt="${escapeHtml(testimoni.name)}" 
                                             style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                    </td>
                                    <td>${escapeHtml(testimoni.name || '')}</td>
                                    <td>${testimoni.old ? testimoni.old + ' years' : ''}</td>
                                    <td>${escapeHtml((testimoni.text_testi || '').substring(0, 100))}${(testimoni.text_testi || '').length > 100 ? '...' : ''}</td>
                                    <td class="actions">
                                        <button class="btn btn-sm btn-secondary" onclick="editItem('testimoni', ${testimoni.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteItem('testimoni', ${testimoni.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                testimoniTable.innerHTML = `<div class="error">Error loading testimonials: ${error.message}</div>`;
            }
        }

        // Load notes data
        async function loadNotes() {
            const notesTable = document.getElementById('notesTable');
            notesTable.innerHTML = '<div class="loading">Loading articles...</div>';

            try {
                const { data, error } = await supabase
                    .from('notes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (!data || data.length === 0) {
                    notesTable.innerHTML = '<div class="empty-state">No articles found</div>';
                    return;
                }

                notesTable.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Content</th>
                                <th>Published</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(note => `
                                <tr>
                                    <td>${escapeHtml(note.title || '')}</td>
                                    <td>${escapeHtml((note.content || '').substring(0, 100))}${(note.content || '').length > 100 ? '...' : ''}</td>
                                    <td>${note.is_published ? 'Yes' : 'No'}</td>
                                    <td>${new Date(note.created_at).toLocaleDateString()}</td>
                                    <td class="actions">
                                        <button class="btn btn-sm btn-secondary" onclick="editItem('notes', ${note.id})">Edit</button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteItem('notes', ${note.id})">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                notesTable.innerHTML = `<div class="error">Error loading articles: ${error.message}</div>`;
            }
        }

        // Open modal for adding/editing
        function openModal(type, id = null) {
            modalTitle.textContent = id ? `Edit ${type}` : `Add ${type}`;
            
            let formHTML = '';
            switch (type) {
                case 'team':
                    formHTML = getTeamForm(id);
                    break;
                case 'testimoni':
                    formHTML = getTestimoniForm(id);
                    break;
                case 'notes':
                    formHTML = getNotesForm(id);
                    break;
            }

            modalBody.innerHTML = formHTML;
            modal.style.display = 'block';

            // Set up form submission
            const form = document.getElementById('itemForm');
            if (form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveItem(type, id);
                });
            }
        }

        // Close modal
        function closeModal() {
            modal.style.display = 'none';
            modalBody.innerHTML = '';
        }

        // Get team form HTML
        function getTeamForm(id = null) {
            return `
                <form id="itemForm">
                    <div class="form-group">
                        <label for="photo">Photo URL</label>
                        <input type="url" id="photo" name="photo" placeholder="https://example.com/photo.jpg">
                    </div>
                    <div class="form-group">
                        <label for="nama">Name *</label>
                        <input type="text" id="nama" name="nama" required>
                    </div>
                    <div class="form-group">
                        <label for="jabatan">Position</label>
                        <input type="text" id="jabatan" name="jabatan" placeholder="UI/UX Designer">
                    </div>
                    <div class="form-group">
                        <label for="moto">Motto</label>
                        <textarea id="moto" name="moto" placeholder="Design with empathy"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" placeholder="name@example.com">
                    </div>
                    <div class="form-group">
                        <label for="instagram">Instagram</label>
                        <input type="text" id="instagram" name="instagram" placeholder="@username">
                    </div>
                    <div class="form-group">
                        <label for="twitter">Twitter</label>
                        <input type="text" id="twitter" name="twitter" placeholder="@username">
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn">${id ? 'Update' : 'Save'}</button>
                    </div>
                </form>
            `;
        }

        // Get testimoni form HTML
        function getTestimoniForm(id = null) {
            return `
                <form id="itemForm">
                    <div class="form-group">
                        <label for="name">Name *</label>
                        <input type="text" id="name" name="name" required>
                    </div>
                    <div class="form-group">
                        <label for="old">Age</label>
                        <input type="number" id="old" name="old" min="0" placeholder="25">
                    </div>
                    <div class="form-group">
                        <label for="image">Photo URL</label>
                        <input type="url" id="image" name="image" placeholder="https://example.com/photo.jpg">
                    </div>
                    <div class="form-group">
                        <label for="text_testi">Testimonial *</label>
                        <textarea id="text_testi" name="text_testi" required placeholder="Write testimonial here..."></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn">${id ? 'Update' : 'Save'}</button>
                    </div>
                </form>
            `;
        }

        // Get notes form HTML
        function getNotesForm(id = null) {
            return `
                <form id="itemForm">
                    <div class="form-group">
                        <label for="title">Title *</label>
                        <input type="text" id="title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="content">Content *</label>
                        <textarea id="content" name="content" required placeholder="Write article content here..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="is_published" name="is_published"> Published
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn">${id ? 'Update' : 'Save'}</button>
                    </div>
                </form>
            `;
        }

        // Save item
        async function saveItem(type, id = null) {
            const form = document.getElementById('itemForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());

            // Convert checkbox to boolean
            if (data.is_published !== undefined) {
                data.is_published = formData.has('is_published');
            }

            try {
                if (id) {
                    // Update existing item
                    const { error } = await supabase
                        .from(type)
                        .update(data)
                        .eq('id', id);
                    
                    if (error) throw error;
                } else {
                    // Create new item
                    const { error } = await supabase
                        .from(type)
                        .insert(data);
                    
                    if (error) throw error;
                }

                closeModal();
                await loadSection(currentSection);
            } catch (error) {
                alert('Error saving item: ' + error.message);
            }
        }

        // Edit item
        async function editItem(type, id) {
            try {
                const { data, error } = await supabase
                    .from(type)
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                openModal(type, id);

                // Populate form with existing data
                setTimeout(() => {
                    Object.keys(data).forEach(key => {
                        const input = document.getElementById(key);
                        if (input) {
                            if (input.type === 'checkbox') {
                                input.checked = data[key];
                            } else {
                                input.value = data[key] || '';
                            }
                        }
                    });
                }, 100);
            } catch (error) {
                alert('Error loading item: ' + error.message);
            }
        }

        // Delete item
        async function deleteItem(type, id) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from(type)
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                await loadSection(currentSection);
            } catch (error) {
                alert('Error deleting item: ' + error.message);
            }
        }

        // Utility function
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Make functions globally available
        window.loadSection = loadSection;
        window.openModal = openModal;
        window.closeModal = closeModal;
        window.editItem = editItem;
        window.deleteItem = deleteItem;

        // Initialize the application
        init();
    </script>
</body>
</html>
